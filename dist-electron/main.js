"use strict";var E=Object.create;var P=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var $=Object.getPrototypeOf,v=Object.prototype.hasOwnProperty;var J=(r,e,s)=>e in r?P(r,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[e]=s;var F=(r,e,s,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of _(e))!v.call(r,n)&&n!==s&&P(r,n,{get:()=>e[n],enumerable:!(t=S(e,n))||t.enumerable});return r};var g=(r,e,s)=>(s=r!=null?E($(r)):{},F(e||!r||!r.__esModule?P(s,"default",{value:r,enumerable:!0}):s,r));var h=(r,e,s)=>J(r,typeof e!="symbol"?e+"":e,s);const c=require("electron"),W=require("path"),y=require("whatsapp-web.js"),z=require("qrcode-terminal");function R(r){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(r){for(const s in r)if(s!=="default"){const t=Object.getOwnPropertyDescriptor(r,s);Object.defineProperty(e,s,t.get?t:{enumerable:!0,get:()=>r[s]})}}return e.default=r,Object.freeze(e)}const D=R(z);class k{constructor(e){h(this,"client",null);h(this,"mainWindow",null);h(this,"status","disconnected");this.mainWindow=e,this.initializeClient()}initializeClient(){try{console.log("[WhatsAppManager] Initializing client..."),this.client=new y.Client({authStrategy:new y.LocalAuth({dataPath:".wwebjs_auth"}),puppeteer:{headless:!0,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--no-zygote","--disable-gpu"]}}),this.setupEventHandlers()}catch(e){console.error("[WhatsAppManager] Error initializing client:",e),this.status="disconnected",this.broadcastStatus("disconnected")}}setupEventHandlers(){this.client&&(this.client.on("qr",e=>{console.log("[WhatsAppManager] QR Code received"),D.generate(e,{small:!0}),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:qr-code",e),this.status="connecting",this.broadcastStatus("connecting")}),this.client.on("ready",()=>{console.log("[WhatsAppManager] Client is ready!"),this.status="ready",this.broadcastStatus("ready")}),this.client.on("authenticated",()=>{console.log("[WhatsAppManager] Client authenticated")}),this.client.on("auth_failure",e=>{console.error("[WhatsAppManager] Authentication failed:",e),this.status="disconnected",this.broadcastStatus("disconnected"),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:error",{type:"auth_failure",message:"Authentication failed. Please try again."})}),this.client.on("disconnected",e=>{console.log("[WhatsAppManager] Client disconnected:",e),this.status="disconnected",this.broadcastStatus("disconnected")}),this.client.on("loading_screen",(e,s)=>{console.log(`[WhatsAppManager] Loading... ${e}% - ${s}`)}),this.client.on("message",async e=>{console.log("[WhatsAppManager] Message received:",e.from),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:message-received",{id:e.id._serialized,from:e.from,to:e.to,body:e.body,type:e.type,timestamp:e.timestamp,hasMedia:e.hasMedia})}))}async connect(){try{if(console.log("[WhatsAppManager] Connecting..."),!this.client)throw new Error("Client not initialized");return this.status==="ready"?(console.log("[WhatsAppManager] Already connected"),!0):(this.status="connecting",this.broadcastStatus("connecting"),await this.client.initialize(),!0)}catch(e){throw console.error("[WhatsAppManager] Connection error:",e),this.status="disconnected",this.broadcastStatus("disconnected"),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:error",{type:"connection_error",message:e instanceof Error?e.message:"Unknown connection error"}),e}}async disconnect(){try{console.log("[WhatsAppManager] Disconnecting..."),this.client&&(await this.client.destroy(),this.client=null),this.status="disconnected",this.broadcastStatus("disconnected")}catch(e){throw console.error("[WhatsAppManager] Disconnect error:",e),this.status="disconnected",this.broadcastStatus("disconnected"),e}}formatPhoneNumber(e){let s=e.replace(/\D/g,"");return s.startsWith("0")&&(s="62"+s.slice(1)),s.endsWith("@c.us")||(s+="@c.us"),s}async downloadFile(e){const s=await import("https"),t=await import("http"),n=await import("fs"),a=await import("path"),o=await import("os");return new Promise((l,d)=>{try{const w=o.tmpdir(),C=`whatsapp_media_${Date.now()}_${a.basename(e).split("?")[0]}`,u=a.join(w,C);console.log(`[WhatsAppManager] Downloading to: ${u}`);const A=e.startsWith("https://")?s:t,M=n.createWriteStream(u);A.get(e,f=>{if(f.statusCode!==200){d(new Error(`Failed to download file: HTTP ${f.statusCode}`));return}f.pipe(M),M.on("finish",()=>{M.close(),console.log(`[WhatsAppManager] Download complete: ${u}`),l(u)}),M.on("error",I=>{n.unlink(u,()=>{}),d(I)})}).on("error",f=>{n.unlink(u,()=>{}),d(f)})}catch(w){d(w)}})}async sendMessage(e,s){try{if(!this.client||this.status!=="ready")throw new Error("WhatsApp client is not ready");const t=this.formatPhoneNumber(e);return console.log(`[WhatsAppManager] Sending message to ${e} (formatted: ${t})`),await this.client.sendMessage(t,s),console.log(`[WhatsAppManager] Message sent successfully to ${e}`),!0}catch(t){throw console.error("[WhatsAppManager] Send message error:",t),t}}async sendMessageWithMedia(e,s,t){let n=null;try{if(!this.client||this.status!=="ready")throw new Error("WhatsApp client is not ready");const a=this.formatPhoneNumber(e);console.log(`[WhatsAppManager] Sending media message to ${e} (formatted: ${a})`);let o;return t.startsWith("http://")||t.startsWith("https://")?(console.log(`[WhatsAppManager] Downloading remote file: ${t}`),n=await this.downloadFile(t),o=y.MessageMedia.fromFilePath(n)):o=y.MessageMedia.fromFilePath(t),await this.client.sendMessage(a,o,{caption:s}),console.log(`[WhatsAppManager] Media message sent successfully to ${e}`),!0}catch(a){throw console.error("[WhatsAppManager] Send media message error:",a),a}finally{if(n)try{(await import("fs")).unlinkSync(n),console.log(`[WhatsAppManager] Cleaned up temp file: ${n}`)}catch(a){console.warn(`[WhatsAppManager] Failed to clean up temp file: ${n}`,a)}}}getStatus(){return this.status}isReady(){return this.status==="ready"&&this.client!==null}broadcastStatus(e){this.mainWindow&&this.mainWindow.webContents.send("whatsapp:status-change",e)}async getClientInfo(){try{if(!this.client||this.status!=="ready")return null;const e=this.client.info;return{wid:e.wid._serialized,pushname:e.pushname,platform:e.platform}}catch(e){return console.error("[WhatsAppManager] Get client info error:",e),null}}}class q{constructor(e,s){h(this,"whatsappManager");h(this,"mainWindow");h(this,"isProcessing",!1);h(this,"isPaused",!1);h(this,"currentJob",null);this.whatsappManager=e,this.mainWindow=s}getCurrentJob(){return this.currentJob}async processJob(e){var a;if(this.isProcessing)throw new Error("Already processing a job");this.isProcessing=!0,this.currentJob=e,this.isPaused=!1,console.log(`[MessageProcessor] Starting job ${e.jobId} with ${e.contacts.length} contacts`);let s=0,t=0,n=0;this.reportProgress(e.jobId,s,e.contacts.length,t,n,"processing");for(const o of e.contacts){if(this.isPaused&&(this.reportProgress(e.jobId,s,e.contacts.length,t,n,"paused"),await this.waitForResume(),this.reportProgress(e.jobId,s,e.contacts.length,t,n,"processing")),!this.isProcessing)break;try{let l=e.template.content||"";if(e.template.variants&&e.template.variants.length>0){const w=Math.floor(Math.random()*e.template.variants.length);l=e.template.variants[w]}const d=this.formatMessage(l,o);console.log(`[MessageProcessor] Template has ${((a=e.template.variants)==null?void 0:a.length)||0} variants`),console.log(`[MessageProcessor] Selected template content: "${l}"`),console.log(`[MessageProcessor] Formatted message: "${d}"`),console.log(`[MessageProcessor] Has assets: ${e.assets&&e.assets.length>0}`),e.assets&&e.assets.length>0?await this.whatsappManager.sendMessageWithMedia(o.phone,d,e.assets[0]):await this.whatsappManager.sendMessage(o.phone,d),t++}catch(l){console.error(`[MessageProcessor] Failed to send to ${o.phone}:`,l),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:job-error-detail",{jobId:e.jobId,phone:o.phone,error:l instanceof Error?l.message:String(l)}),n++}s++,this.reportProgress(e.jobId,s,e.contacts.length,t,n,"processing"),await this.delay(2e3+Math.random()*3e3)}this.isProcessing=!1,this.currentJob=null,this.reportProgress(e.jobId,s,e.contacts.length,t,n,"completed"),console.log(`[MessageProcessor] Job ${e.jobId} completed`)}pause(){return this.isProcessing&&!this.isPaused?(this.isPaused=!0,console.log("[MessageProcessor] Job paused"),!0):!1}resume(){return this.isProcessing&&this.isPaused?(this.isPaused=!1,console.log("[MessageProcessor] Job resumed"),!0):!1}stop(){return this.isProcessing?(this.isProcessing=!1,this.isPaused=!1,this.currentJob=null,console.log("[MessageProcessor] Job stopped"),!0):!1}formatMessage(e,s){let t=e;t=t.replace(/{{name}}/g,s.name||""),t=t.replace(/{{phone}}/g,s.phone||"");const n=t.match(/{{(.*?)}}/g);return n&&n.forEach(a=>{const o=a.replace(/{{|}}/g,"");s[o]!==void 0&&(t=t.replace(new RegExp(a,"g"),String(s[o])))}),t}reportProgress(e,s,t,n,a,o){this.mainWindow&&this.mainWindow.webContents.send("whatsapp:job-progress",{jobId:e,processed:s,total:t,success:n,failed:a,status:o})}delay(e){return new Promise(s=>setTimeout(s,e))}waitForResume(){return new Promise(e=>{const s=setInterval(()=>{this.isPaused||(clearInterval(s),e())},500)})}}let i=null,p=null;const T=r=>{console.log("[IPC] Setting up IPC handlers..."),i=new k(r),p=new q(i,r),c.ipcMain.handle("whatsapp:connect",async()=>{try{if(console.log("[IPC] whatsapp:connect called"),!i)throw new Error("WhatsAppManager not initialized");return{success:!0,connected:await i.connect()}}catch(e){return console.error("[IPC] whatsapp:connect error:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}),c.ipcMain.handle("whatsapp:disconnect",async()=>{try{if(console.log("[IPC] whatsapp:disconnect called"),!i)throw new Error("WhatsAppManager not initialized");return await i.disconnect(),{success:!0}}catch(e){return console.error("[IPC] whatsapp:disconnect error:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}),c.ipcMain.handle("whatsapp:send-message",async(e,{to:s,content:t,assets:n})=>{try{if(console.log(`[IPC] whatsapp:send-message called for ${s}`),!i)throw new Error("WhatsAppManager not initialized");let a;return n&&n.length>0?a=await i.sendMessageWithMedia(s,t,n[0]):a=await i.sendMessage(s,t),{success:a}}catch(a){return console.error("[IPC] whatsapp:send-message error:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}),c.ipcMain.handle("whatsapp:get-status",async()=>{try{if(!i)return{status:"disconnected",ready:!1};const e=i.getStatus(),s=i.isReady();return{status:e,ready:s}}catch(e){return console.error("[IPC] whatsapp:get-status error:",e),{status:"disconnected",ready:!1}}}),c.ipcMain.handle("whatsapp:get-client-info",async()=>{try{return console.log("[IPC] whatsapp:get-client-info called"),i?await i.getClientInfo():null}catch(e){return console.error("[IPC] whatsapp:get-client-info error:",e),null}}),c.ipcMain.handle("whatsapp:process-job",async(e,{jobId:s,contacts:t,template:n,assets:a})=>{try{if(console.log(`[IPC] whatsapp:process-job called for job ${s}`),!i||!i.isReady())throw new Error("WhatsApp is not ready");if(!p)throw new Error("MessageProcessor not initialized");return p.processJob({jobId:s,contacts:t,template:n,assets:a}).catch(o=>{console.error("[IPC] Job processing error:",o)}),{success:!0,message:"Job started",jobId:s}}catch(o){return console.error("[IPC] whatsapp:process-job error:",o),{success:!1,error:o instanceof Error?o.message:"Unknown error"}}}),c.ipcMain.handle("whatsapp:pause-job",async(e,{jobId:s})=>{if(console.log(`[IPC] whatsapp:pause-job called for job ${s}`),p){const t=p.pause();return{success:t,message:t?"Job paused":"Failed to pause"}}return{success:!1,message:"Processor not ready"}}),c.ipcMain.handle("whatsapp:resume-job",async(e,{jobId:s})=>{if(console.log(`[IPC] whatsapp:resume-job called for job ${s}`),p){const t=p.resume();return{success:t,message:t?"Job resumed":"Failed to resume"}}return{success:!1,message:"Processor not ready"}}),console.log("[IPC] IPC handlers setup complete")};let m=null;const b=()=>{m=new c.BrowserWindow({width:1200,height:800,webPreferences:{preload:W.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0}}),T(m),process.env.VITE_DEV_SERVER_URL?(m.loadURL(process.env.VITE_DEV_SERVER_URL),m.webContents.openDevTools()):m.loadFile(W.join(__dirname,"../dist/index.html"))};c.app.on("ready",b);c.app.on("window-all-closed",()=>{process.platform!=="darwin"&&c.app.quit()});c.app.on("activate",()=>{c.BrowserWindow.getAllWindows().length===0&&b()});

"use strict";var F=Object.create;var k=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var x=(o,e,s)=>e in o?k(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var U=(o,e,s,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of z(e))!j.call(o,t)&&t!==s&&k(o,t,{get:()=>e[t],enumerable:!(n=J(e,t))||n.enumerable});return o};var M=(o,e,s)=>(s=o!=null?F(Q(o)):{},U(e||!o||!o.__esModule?k(s,"default",{value:o,enumerable:!0}):s,o));var c=(o,e,s)=>x(o,typeof e!="symbol"?e+"":e,s);const l=require("electron"),f=require("path"),y=require("whatsapp-web.js"),T=require("qrcode-terminal"),H=require("fs");function L(o){const e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(o){for(const s in o)if(s!=="default"){const n=Object.getOwnPropertyDescriptor(o,s);Object.defineProperty(e,s,n.get?n:{enumerable:!0,get:()=>o[s]})}}return e.default=o,Object.freeze(e)}const V=L(T);class E{constructor(e){c(this,"client",null);c(this,"mainWindow",null);c(this,"status","disconnected");c(this,"messageReceiverWorker",null);this.mainWindow=e,this.initializeClient()}setMessageReceiverWorker(e){this.messageReceiverWorker=e}getChromiumExecutablePath(){if(!l.app.isPackaged)return;const e=f.join(process.resourcesPath,"app.asar.unpacked","node_modules","whatsapp-web.js","node_modules","puppeteer-core",".local-chromium","win64-1045629","chrome-win","chrome.exe");if(console.log("[WhatsAppManager] Checking Chromium path:",e),H.existsSync(e))return console.log("[WhatsAppManager] Chromium found at:",e),e;console.error("[WhatsAppManager] Chromium not found at expected path:",e)}initializeClient(){try{console.log("[WhatsAppManager] Initializing client...");const e=this.getChromiumExecutablePath(),s={headless:!0,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--no-zygote","--disable-gpu"]};e&&(s.executablePath=e),console.log("[WhatsAppManager] Puppeteer config:",JSON.stringify(s,null,2)),this.client=new y.Client({authStrategy:new y.LocalAuth({dataPath:l.app.isPackaged?f.join(l.app.getPath("userData"),".wwebjs_auth"):".wwebjs_auth"}),puppeteer:s}),this.setupEventHandlers()}catch(e){console.error("[WhatsAppManager] Error initializing client:",e),this.status="disconnected",this.broadcastStatus("disconnected")}}setupEventHandlers(){this.client&&(this.client.on("qr",e=>{console.log("[WhatsAppManager] QR Code received"),V.generate(e,{small:!0}),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:qr-code",e),this.status="connecting",this.broadcastStatus("connecting")}),this.client.on("ready",()=>{console.log("[WhatsAppManager] Client is ready!"),this.status="ready",this.broadcastStatus("ready")}),this.client.on("authenticated",()=>{console.log("[WhatsAppManager] Client authenticated")}),this.client.on("auth_failure",e=>{console.error("[WhatsAppManager] Authentication failed:",e),this.status="disconnected",this.broadcastStatus("disconnected"),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:error",{type:"auth_failure",message:"Authentication failed. Please try again."})}),this.client.on("disconnected",e=>{console.log("[WhatsAppManager] Client disconnected:",e),this.status="disconnected",this.broadcastStatus("disconnected")}),this.client.on("loading_screen",(e,s)=>{console.log(`[WhatsAppManager] Loading... ${e}% - ${s}`)}),this.client.on("message",async e=>{console.log("[WhatsAppManager] Message received:",e.from),this.messageReceiverWorker?await this.messageReceiverWorker.handleIncomingMessage(e):this.mainWindow&&this.mainWindow.webContents.send("whatsapp:message-received",{id:e.id._serialized,from:e.from,to:e.to,body:e.body,type:e.type,timestamp:e.timestamp,hasMedia:e.hasMedia})}))}async connect(){try{if(console.log("[WhatsAppManager] Connecting..."),!this.client)throw new Error("Client not initialized");return this.status==="ready"?(console.log("[WhatsAppManager] Already connected"),!0):(this.status="connecting",this.broadcastStatus("connecting"),await this.client.initialize(),!0)}catch(e){throw console.error("[WhatsAppManager] Connection error:",e),this.status="disconnected",this.broadcastStatus("disconnected"),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:error",{type:"connection_error",message:e instanceof Error?e.message:"Unknown connection error"}),e}}async disconnect(){try{console.log("[WhatsAppManager] Disconnecting..."),this.client&&(await this.client.destroy(),this.client=null),this.status="disconnected",this.broadcastStatus("disconnected"),this.initializeClient()}catch(e){throw console.error("[WhatsAppManager] Disconnect error:",e),this.status="disconnected",this.broadcastStatus("disconnected"),e}}formatPhoneNumber(e){let s=e.replace(/\D/g,"");return s.startsWith("0")&&(s="62"+s.slice(1)),s.endsWith("@c.us")||(s+="@c.us"),s}async downloadFile(e){const s=await import("https"),n=await import("http"),t=await import("fs"),r=await import("path"),a=await import("os");return new Promise((h,i)=>{try{const u=a.tmpdir(),$=`whatsapp_media_${Date.now()}_${r.basename(e).split("?")[0]}`,m=r.join(u,$);console.log(`[WhatsAppManager] Downloading to: ${m}`);const q=e.startsWith("https://")?s:n,b=t.createWriteStream(m);q.get(e,W=>{if(W.statusCode!==200){i(new Error(`Failed to download file: HTTP ${W.statusCode}`));return}W.pipe(b),b.on("finish",()=>{b.close(),console.log(`[WhatsAppManager] Download complete: ${m}`),h(m)}),b.on("error",D=>{t.unlink(m,()=>{}),i(D)})}).on("error",W=>{t.unlink(m,()=>{}),i(W)})}catch(u){i(u)}})}async sendMessage(e,s){try{if(!this.client||this.status!=="ready")throw new Error("WhatsApp client is not ready");const n=this.formatPhoneNumber(e);return console.log(`[WhatsAppManager] Sending message to ${e} (formatted: ${n})`),await this.client.sendMessage(n,s),console.log(`[WhatsAppManager] Message sent successfully to ${e}`),!0}catch(n){throw console.error("[WhatsAppManager] Send message error:",n),n}}async sendMessageWithMedia(e,s,n){let t=null;try{if(!this.client||this.status!=="ready")throw new Error("WhatsApp client is not ready");const r=this.formatPhoneNumber(e);console.log(`[WhatsAppManager] Sending media message to ${e} (formatted: ${r})`);let a;return n.startsWith("http://")||n.startsWith("https://")?(console.log(`[WhatsAppManager] Downloading remote file: ${n}`),t=await this.downloadFile(n),a=y.MessageMedia.fromFilePath(t)):a=y.MessageMedia.fromFilePath(n),await this.client.sendMessage(r,a,{caption:s}),console.log(`[WhatsAppManager] Media message sent successfully to ${e}`),!0}catch(r){throw console.error("[WhatsAppManager] Send media message error:",r),r}finally{if(t)try{(await import("fs")).unlinkSync(t),console.log(`[WhatsAppManager] Cleaned up temp file: ${t}`)}catch(r){console.warn(`[WhatsAppManager] Failed to clean up temp file: ${t}`,r)}}}getStatus(){return this.status}isReady(){return this.status==="ready"&&this.client!==null}broadcastStatus(e){this.mainWindow&&!this.mainWindow.isDestroyed()&&this.mainWindow.webContents.send("whatsapp:status-change",e)}async getClientInfo(){try{if(!this.client||this.status!=="ready")return null;const e=this.client.info;return{wid:e.wid._serialized,pushname:e.pushname,platform:e.platform}}catch(e){return console.error("[WhatsAppManager] Get client info error:",e),null}}}class _{constructor(e,s){c(this,"whatsappManager");c(this,"mainWindow");c(this,"isProcessing",!1);c(this,"isPaused",!1);c(this,"currentJob",null);this.whatsappManager=e,this.mainWindow=s}getCurrentJob(){return this.currentJob}async processJob(e){var r;if(this.isProcessing)throw new Error("Already processing a job");this.isProcessing=!0,this.currentJob=e,this.isPaused=!1,console.log(`[MessageProcessor] Starting job ${e.jobId} with ${e.contacts.length} contacts`);let s=0,n=0,t=0;this.reportProgress(e.jobId,s,e.contacts.length,n,t,"processing");for(const a of e.contacts){if(this.isPaused&&(this.reportProgress(e.jobId,s,e.contacts.length,n,t,"paused"),await this.waitForResume(),this.reportProgress(e.jobId,s,e.contacts.length,n,t,"processing")),!this.isProcessing)break;try{let h=e.template.content||"";if(e.template.variants&&e.template.variants.length>0){const u=Math.floor(Math.random()*e.template.variants.length);h=e.template.variants[u]}const i=this.formatMessage(h,a);console.log(`[MessageProcessor] Template has ${((r=e.template.variants)==null?void 0:r.length)||0} variants`),console.log(`[MessageProcessor] Selected template content: "${h}"`),console.log(`[MessageProcessor] Formatted message: "${i}"`),console.log(`[MessageProcessor] Has assets: ${e.assets&&e.assets.length>0}`),e.assets&&e.assets.length>0?await this.whatsappManager.sendMessageWithMedia(a.phone,i,e.assets[0]):await this.whatsappManager.sendMessage(a.phone,i),n++}catch(h){console.error(`[MessageProcessor] Failed to send to ${a.phone}:`,h),this.mainWindow&&this.mainWindow.webContents.send("whatsapp:job-error-detail",{jobId:e.jobId,phone:a.phone,error:h instanceof Error?h.message:String(h)}),t++}s++,this.reportProgress(e.jobId,s,e.contacts.length,n,t,"processing"),await this.delay(2e3+Math.random()*3e3)}this.isProcessing=!1,this.currentJob=null,this.reportProgress(e.jobId,s,e.contacts.length,n,t,"completed"),console.log(`[MessageProcessor] Job ${e.jobId} completed`)}pause(){return this.isProcessing&&!this.isPaused?(this.isPaused=!0,console.log("[MessageProcessor] Job paused"),!0):!1}resume(){return this.isProcessing&&this.isPaused?(this.isPaused=!1,console.log("[MessageProcessor] Job resumed"),!0):!1}stop(){return this.isProcessing?(this.isProcessing=!1,this.isPaused=!1,this.currentJob=null,console.log("[MessageProcessor] Job stopped"),!0):!1}formatMessage(e,s){let n=e;n=n.replace(/{{name}}/g,s.name||""),n=n.replace(/{{phone}}/g,s.phone||"");const t=n.match(/{{(.*?)}}/g);return t&&t.forEach(r=>{const a=r.replace(/{{|}}/g,"");s[a]!==void 0&&(n=n.replace(new RegExp(r,"g"),String(s[a])))}),n}reportProgress(e,s,n,t,r,a){this.mainWindow&&this.mainWindow.webContents.send("whatsapp:job-progress",{jobId:e,processed:s,total:n,success:t,failed:r,status:a})}delay(e){return new Promise(s=>setTimeout(s,e))}waitForResume(){return new Promise(e=>{const s=setInterval(()=>{this.isPaused||(clearInterval(s),e())},500)})}}class R{constructor(e){c(this,"queue",[]);c(this,"isRunning",!1);c(this,"messageProcessor");this.messageProcessor=e}async addToQueue(e){console.log(`[QueueWorker] Adding job ${e.jobId} to queue`),this.queue.push(e),this.processQueue()}async processQueue(){if(!this.isRunning){for(this.isRunning=!0,console.log("[QueueWorker] Starting queue processing");this.queue.length>0;){const e=this.queue.shift();if(e)try{console.log(`[QueueWorker] Processing job ${e.jobId}`),await this.messageProcessor.processJob(e)}catch(s){console.error(`[QueueWorker] Error processing job ${e.jobId}:`,s)}}this.isRunning=!1,console.log("[QueueWorker] Queue processing finished")}}getQueueLength(){return this.queue.length}}let d=null,g=null,P=null;const N=(o,e,s,n)=>{console.log("[IPC] Setting up IPC handlers..."),e?d=e:(console.log("[IPC] Creating new WhatsAppManager (Fallback)"),d=new E(o)),s?g=s:(console.log("[IPC] Creating new MessageProcessor (Fallback)"),g=new _(d,o)),n?P=n:g&&(console.log("[IPC] Creating new QueueWorker (Fallback)"),P=new R(g)),l.ipcMain.handle("whatsapp:connect",async()=>{try{if(console.log("[IPC] whatsapp:connect called"),!d)throw new Error("WhatsAppManager not initialized");return{success:!0,connected:await d.connect()}}catch(t){return console.error("[IPC] whatsapp:connect error:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}),l.ipcMain.handle("whatsapp:disconnect",async()=>{try{if(console.log("[IPC] whatsapp:disconnect called"),!d)throw new Error("WhatsAppManager not initialized");return await d.disconnect(),{success:!0}}catch(t){return console.error("[IPC] whatsapp:disconnect error:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}),l.ipcMain.handle("whatsapp:send-message",async(t,{to:r,content:a,assets:h})=>{try{if(console.log(`[IPC] whatsapp:send-message called for ${r}`),!d)throw new Error("WhatsAppManager not initialized");let i;return h&&h.length>0?i=await d.sendMessageWithMedia(r,a,h[0]):i=await d.sendMessage(r,a),{success:i}}catch(i){return console.error("[IPC] whatsapp:send-message error:",i),{success:!1,error:i instanceof Error?i.message:"Unknown error"}}}),l.ipcMain.handle("whatsapp:get-status",async()=>{try{if(!d)return{status:"disconnected",ready:!1};const t=d.getStatus(),r=d.isReady();return{status:t,ready:r}}catch(t){return console.error("[IPC] whatsapp:get-status error:",t),{status:"disconnected",ready:!1}}}),l.ipcMain.handle("whatsapp:get-client-info",async()=>{try{return console.log("[IPC] whatsapp:get-client-info called"),d?await d.getClientInfo():null}catch(t){return console.error("[IPC] whatsapp:get-client-info error:",t),null}}),l.ipcMain.handle("whatsapp:process-job",async(t,{jobId:r,contacts:a,template:h,assets:i})=>{try{if(console.log(`[IPC] whatsapp:process-job called for job ${r}`),!d||!d.isReady())throw new Error("WhatsApp is not ready");if(P)console.log(`[IPC] Adding job ${r} to queue`),P.addToQueue({jobId:r,contacts:a,template:h,assets:i}).catch(u=>{console.error("[IPC] Error adding to queue:",u)});else if(g)console.warn("[IPC] QueueWorker not available, processing directly"),g.processJob({jobId:r,contacts:a,template:h,assets:i}).catch(u=>{console.error("[IPC] Job processing error:",u)});else throw new Error("MessageProcessor not initialized");return{success:!0,message:"Job started",jobId:r}}catch(u){return console.error("[IPC] whatsapp:process-job error:",u),{success:!1,error:u instanceof Error?u.message:"Unknown error"}}}),l.ipcMain.handle("whatsapp:pause-job",async(t,{jobId:r})=>{if(console.log(`[IPC] whatsapp:pause-job called for job ${r}`),g){const a=g.pause();return{success:a,message:a?"Job paused":"Failed to pause"}}return{success:!1,message:"Processor not ready"}}),l.ipcMain.handle("whatsapp:resume-job",async(t,{jobId:r})=>{if(console.log(`[IPC] whatsapp:resume-job called for job ${r}`),g){const a=g.resume();return{success:a,message:a?"Job resumed":"Failed to resume"}}return{success:!1,message:"Processor not ready"}}),console.log("[IPC] IPC handlers setup complete")};class O{constructor(e,s){c(this,"whatsappManager");c(this,"mainWindow");c(this,"checkInterval",null);c(this,"CHECK_INTERVAL_MS",3e4);this.whatsappManager=e,this.mainWindow=s}startMonitoring(){this.checkInterval||(console.log("[StatusWorker] Starting status monitoring"),this.checkHealth(),this.checkInterval=setInterval(async()=>{await this.checkHealth()},this.CHECK_INTERVAL_MS))}stopMonitoring(){this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null,console.log("[StatusWorker] Stopped status monitoring"))}async checkHealth(){const e=this.whatsappManager.getStatus();if(console.log(`[StatusWorker] Health check: ${e}`),this.mainWindow&&!this.mainWindow.isDestroyed()&&this.mainWindow.webContents.send("whatsapp:status-change",e),e==="disconnected"){console.log("[StatusWorker] Detected disconnection, attempting reconnect...");try{await this.whatsappManager.connect()}catch(s){console.error("[StatusWorker] Reconnect failed:",s)}}}}class K{constructor(e,s){c(this,"mainWindow");c(this,"unsubscribeKeywords",["unsubscribe","stop","batal","berhenti","jangan kirim","keluar","cancel"]);this.mainWindow=s}async handleIncomingMessage(e){try{console.log("[MessageReceiverWorker] Processing incoming message from:",e.from);const s=this.isUnsubscribeRequest(e.body);s&&(console.log("[MessageReceiverWorker] Unsubscribe request detected from:",e.from),this.mainWindow&&!this.mainWindow.isDestroyed()&&this.mainWindow.webContents.send("whatsapp:unsubscribe-detected",{phoneNumber:e.from,message:e.body,timestamp:new Date().toISOString()})),this.mainWindow&&!this.mainWindow.isDestroyed()&&this.mainWindow.webContents.send("whatsapp:message-received",{id:e.id._serialized,from:e.from,to:e.to,body:e.body,type:e.type,timestamp:e.timestamp,hasMedia:e.hasMedia,isUnsubscribeRequest:s})}catch(s){console.error("[MessageReceiverWorker] Error handling message:",s)}}isUnsubscribeRequest(e){if(!e)return!1;const s=e.toLowerCase();return this.unsubscribeKeywords.some(n=>s.includes(n))}}let p=null,w=null,I=null,A=null,C=null,v=null;const S=()=>{const o=process.env.VITE_DEV_SERVER_URL?f.join(__dirname,"../../public/icon.png"):f.join(f.dirname(l.app.getAppPath()),"icon.ico");if(p=new l.BrowserWindow({width:1200,height:800,autoHideMenuBar:!0,icon:o,webPreferences:{preload:f.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0,webSecurity:!0}}),console.log("[Main] Initializing workers..."),w=new E(p),I=new _(w,p),A=new R(I),C=new O(w,p),v=new K(w,p),w.setMessageReceiverWorker(v),C.startMonitoring(),N(p,w,I,A),process.env.VITE_DEV_SERVER_URL)p.loadURL(process.env.VITE_DEV_SERVER_URL);else{const e=f.join(l.app.getAppPath(),"dist","index.html");console.log("[Main] Loading from:",e),p.loadFile(e)}p.webContents.on("before-input-event",(e,s)=>{(s.key==="F5"||s.control&&s.key==="r")&&e.preventDefault()}),p.webContents.on("did-fail-load",(e,s,n)=>{console.error("[Main] Failed to load:",s,n)}),p.webContents.on("crashed",(e,s)=>{console.error("[Main] Renderer crashed:",s)})};l.app.whenReady().then(()=>{S(),l.app.on("activate",()=>{l.BrowserWindow.getAllWindows().length===0&&S()})});l.app.on("window-all-closed",()=>{C&&C.stopMonitoring(),w&&w.disconnect(),process.platform!=="darwin"&&l.app.quit()});
